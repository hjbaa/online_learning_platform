let quizObj = JSON.parse('<%=raw @test_json %>');
quizObj.currentQuestion = 0;
quizObj.score = 0;
quizObj.selected = [];

function findMaxCorrect(quizObj) {
    let count = 0;
    quizObj.questions.forEach(questElement => {
        questElement.answers.forEach(ansElement => {
            if (ansElement.correct) {
                count++;
            }
        })
    })

    return count;
}

quizObj.clearTestArea = function () {
    let parentNode = document.getElementById('test-passage')
    while (parentNode.firstChild) {
        parentNode.removeChild(parentNode.firstChild);
    }
}

quizObj.createQuizArea = function () {
    const question = quizObj.questions[quizObj.currentQuestion]

    const parentNode = document.getElementById('test-passage')

    // Adding question's title
    const textArea = document.createElement('div');
    textArea.className += 'mb-3 fs-3';
    const titleTag = document.createElement('p');
    titleTag.innerText = 'Question #' + (quizObj.currentQuestion + 1) + ':\t' + question.title;
    textArea.appendChild(titleTag);

    const buttonArea = document.createElement('div');
    buttonArea.className += 'px-3 fs-4';
    const buttonList = document.createElement('ul');
    buttonArea.appendChild(buttonList);

    const emptyButton = document.createElement('a')
    emptyButton.className += 'btn btn-outline-secondary mb-2 w-25'
    emptyButton.setAttribute('href', 'javascript:;')
    let counter = 0;

    // Adding one button to one answer to document.
    question.answers.forEach((element) => {
        let buttonListElement = document.createElement('li');
        buttonListElement.className += 'list-without-dots'

        let answerButton = emptyButton.cloneNode(false);
        answerButton.innerText = element.content;
        answerButton.dataset.number = counter.toString();
        counter++;

        answerButton.addEventListener('click', function (event) {
            event.preventDefault();

            if (this.className.includes('btn-outline-secondary')){
                this.className = this.className.replace('btn-outline-secondary', 'btn-primary');
                quizObj.selected.push(Number(this.dataset.number));
            } else {
                this.className = this.className.replace('btn-primary', 'btn-outline-secondary');
                let value = Number(this.dataset.number)
                quizObj.selected = quizObj.selected.filter(function(item) {
                    return item !== value
                })
            }
        })

        buttonListElement.appendChild(answerButton);

        buttonArea.appendChild(buttonListElement)
    })

    let nextQuestionArea = document.createElement('div');
    nextQuestionArea.className += 'py-3';

    let nextQuestionButton = emptyButton.cloneNode(false);
    nextQuestionButton.className = 'btn btn-success mb-2';

    if (quizObj.isEnded()) {
        nextQuestionButton.innerText = 'End test';
    } else {
        nextQuestionButton.innerText = 'Next question';
    }

    nextQuestionButton.addEventListener('click', function (event) {
        event.preventDefault();
        quizObj.selected.forEach(selectedAnswer => {
            if (quizObj.questions[quizObj.currentQuestion].answers[selectedAnswer]) {
                quizObj.score++;
            }
        })

        if (quizObj.isEnded()) {
            quizObj.endQuiz();
        } else {
            quizObj.nextQuestion();
        }
    })

    nextQuestionArea.appendChild(nextQuestionButton)

    parentNode.appendChild(textArea);
    parentNode.appendChild(buttonArea);
    parentNode.appendChild(nextQuestionArea);
}

quizObj.nextQuestion = function () {
    quizObj.currentQuestion++;
    quizObj.selected = [];

    quizObj.clearTestArea();
    quizObj.createQuizArea();
}

quizObj.isEnded = function () {
    return quizObj.currentQuestion + 1 === quizObj.questions.length
}

quizObj.createQuiz = function () {
    quizObj.clearTestArea();
    quizObj.createQuizArea();
}

quizObj.endQuiz = function () {
    quizObj.clearTestArea();

    // TODO: пофиксить подсчёт результата
    // TODO: добавить коллекцию для результатов
    let resultPercent = quizObj.score / findMaxCorrect(quizObj) * 100;
    let resultArea = document.createElement('div');
    resultArea.className = 'fs-3 py-2';

    let resultLine = document.createElement('p')
    resultLine.innerText = 'Your result: ' + resultPercent + '%';

    resultArea.appendChild(resultLine);

    document.getElementById('test-passage').appendChild(resultArea);
}

quizObj.createQuiz();
